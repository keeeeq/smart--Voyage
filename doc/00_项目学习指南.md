# SmartVoyage 项目学习指南

> 📚 本文档帮助你快速了解和学习 SmartVoyage 智能旅行助手项目。

---

## 📋 目录

1. [项目简介](#1-项目简介)
2. [技术架构](#2-技术架构)
3. [技术栈](#3-技术栈)
4. [快速开始](#4-快速开始)
5. [核心代码解析](#5-核心代码解析)
6. [数据流程详解](#6-数据流程详解)
7. [学习路线](#7-学习路线)
8. [常见问题](#8-常见问题)

---

## 1. 项目简介

### 这是什么项目？

SmartVoyage 是一个**智能旅行助手**，用户可以通过自然语言查询：
- 🌤️ 天气信息（"北京明天天气"）
- 🚄 火车票（"北京到上海的火车票"）
- ✈️ 机票（"北京到广州的航班"）
- 🎤 演唱会（"五月天演唱会"）
- 📝 票务预定（"帮我订一张五月天的票"）

### 核心亮点

1. **分布式微服务架构** - 8 个独立服务协作
2. **MCP 协议** - 标准化 LLM 工具调用
3. **A2A 协议** - Agent 之间的通信协议
4. **LLM 驱动** - 意图识别、SQL 生成、结果润色

---

## 2. 技术架构

### 三层分布式架构

```
                              用户
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    Streamlit 前端 (:8502)                    │
│                        纯 UI 展示                            │
└─────────────────────────────────────────────────────────────┘
                                │ HTTP
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    API 网关 (:8000)                          │
│         意图识别 (LLM) → Agent 路由 → 结果润色 (LLM)         │
└─────────────────────────────────────────────────────────────┘
                                │ A2A Protocol
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                     A2A Agent 层                             │
│  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐      │
│  │ 天气Agent     │ │ 票务Agent     │ │ 订票Agent     │      │
│  │ :5005         │ │ :5006         │ │ :5007         │      │
│  │ LLM生成SQL    │ │ LLM生成SQL    │ │ 调用票务Agent │      │
│  └───────────────┘ └───────────────┘ └───────────────┘      │
└─────────────────────────────────────────────────────────────┘
                                │ MCP Protocol
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                     MCP Server 层                            │
│  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐      │
│  │ 天气MCP       │ │ 票务MCP       │ │ 订票MCP       │      │
│  │ :8002         │ │ :8001         │ │ :8003         │      │
│  │ 执行SQL查询   │ │ 执行SQL查询   │ │ 模拟预定      │      │
│  └───────────────┘ └───────────────┘ └───────────────┘      │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
                           MySQL 数据库
```

### 服务端口一览

| 服务 | 端口 | 说明 |
|------|------|------|
| MCP 票务 | 8001 | 票务数据查询工具 |
| MCP 天气 | 8002 | 天气数据查询工具 |
| MCP 订票 | 8003 | 票务预定工具 |
| A2A 天气 | 5005 | 天气查询 Agent |
| A2A 票务 | 5006 | 票务查询 Agent |
| A2A 订票 | 5007 | 票务预定 Agent |
| API 网关 | 8000 | 意图识别+路由+润色 |
| Streamlit | 8502 | 前端界面 |

---

## 3. 技术栈

### 核心依赖

| 技术 | 作用 | 文档 |
|------|------|------|
| **LangChain** | LLM 应用框架 | [docs.langchain.com](https://docs.langchain.com) |
| **FastMCP** | MCP 协议实现 | [github.com/modelcontextprotocol](https://github.com/modelcontextprotocol) |
| **python-a2a** | A2A 协议实现 | [github.com/python-a2a](https://github.com/themanojdesai/python-a2a) |
| **FastAPI** | API 网关框架 | [fastapi.tiangolo.com](https://fastapi.tiangolo.com) |
| **Streamlit** | 前端框架 | [streamlit.io](https://streamlit.io) |
| **MySQL** | 数据库 | - |

### 关键概念

#### MCP（Model Context Protocol）
- Anthropic 开源的协议
- 让 LLM 可以调用外部工具
- 类似于"给 LLM 装上手和脚"

#### A2A（Agent-to-Agent Protocol）
- Agent 之间的通信协议
- Agent Card：描述 Agent 能力的"名片"
- Task：Agent 之间传递的任务单元

---

## 4. 快速开始

### 4.1 环境准备

```bash
# 1. 创建虚拟环境
conda create -n agent python=3.12
conda activate agent

# 2. 安装依赖
pip install -r requirements.txt

# 3. 配置 .env
# 编辑 .env 文件，填入 MySQL 和 LLM API 配置
```

### 4.2 初始化数据库

```bash
# 创建数据库
mysql -u root -p < database/init_db.sql

# 插入测试数据
python database/insert_test_data.py
```

### 4.3 启动服务

**方式1：一键启动**
```bash
# Windows
start_a2a.bat
```

**方式2：PyCharm**
选择 "🚀 启动全部服务" 运行配置

### 4.4 访问应用

- 前端界面：http://localhost:8502
- API 文档：http://localhost:8000/docs

---

## 5. 核心代码解析

### 5.1 API 网关 (`api_gateway.py`)

```python
# 意图识别
intents, queries, _ = intent_recognize(message, history)
# 返回: ["weather"], {"weather": "北京 2026-01-12 天气"}

# 根据意图选择 Agent
if intent == "weather":
    agent_name = "WeatherQueryAssistant"
elif intent in ["train", "flight", "concert"]:
    agent_name = "TicketQueryAssistant"

# 调用 Agent
result = await call_agent(agent_name, query, history)

# 结果润色
final = summarize_result(intent, query, result)
```

### 5.2 A2A Agent (`a2a_server/ticket_server.py`)

```python
class TicketQueryServer(A2AServer):
    def handle_task(self, task):
        # 1. 从 task 获取用户输入
        conversation = task.message["content"]["text"]
        
        # 2. LLM 生成 SQL
        sql = self.generate_sql(conversation)
        # 例: SELECT * FROM concert_ticket WHERE artist LIKE '%五月天%'
        
        # 3. 调用 MCP 执行 SQL
        result = asyncio.run(get_tickets(sql))
        
        # 4. 返回结果
        task.artifacts = [{"parts": [{"text": result}]}]
        task.status = TaskStatus(state=TaskState.COMPLETED)
        return task
```

### 5.3 MCP Server (`mcp_server/mcp_ticket_server.py`)

```python
from mcp.server.fastmcp import FastMCP

# 创建 MCP 服务器
ticket_mcp = FastMCP(name="TicketTools", port=8001)

# 注册工具
@ticket_mcp.tool(name="query_tickets")
def query_tickets(sql: str) -> str:
    cursor.execute(sql)  # 执行 SQL
    return json.dumps(results)

# 启动
ticket_mcp.run(transport="streamable-http")
```

---

## 6. 数据流程详解

### 用户问："五月天在上海有演出吗"

```
1. [Streamlit] 用户输入 "五月天在上海有演出吗"
       ↓
2. [API网关] 意图识别 (LLM调用)
   输出: {"intents": ["concert"], "user_queries": {"concert": "五月天 上海 演唱会"}}
       ↓
3. [API网关] 路由到 TicketQueryAssistant (:5006)
       ↓
4. [票务Agent] LLM 生成 SQL
   输出: SELECT * FROM concert_ticket WHERE artist LIKE '%五月天%' AND city = '上海'
       ↓
5. [票务Agent] 调用 MCP (:8001)
       ↓
6. [票务MCP] 执行 SQL，返回 JSON
   {"status": "success", "data": [{...}]}
       ↓
7. [票务Agent] 格式化结果
   "五月天演唱会-上海站 | 五月天 | 上海 梅奔中心 | 日期:2026-01-26 | 票价:¥280-¥1280"
       ↓
8. [API网关] 结果润色 (LLM调用)
   "五月天将于2026年1月26日在上海梅奔中心举办演唱会，票价280-1280元。"
       ↓
9. [Streamlit] 显示给用户
```

### LLM 调用点

| 阶段 | 位置 | 作用 |
|------|------|------|
| 意图识别 | API网关 | 判断用户想做什么 |
| SQL生成 | A2A Agent | 自然语言转SQL |
| 结果润色 | API网关 | 结构化数据转自然语言 |

---

## 7. 学习路线

### 第一阶段：基础概念（1-2天）

1. 阅读 `doc/01_项目结构与环境搭建.md`
2. 阅读 `doc/02_数据库设计与连接.md`
3. 启动项目，体验功能

### 第二阶段：LLM 集成（2-3天）

1. 阅读 `doc/04_LLM与SQL生成.md`
2. 研究 `main_prompts.py` 中的提示词
3. 修改提示词，观察效果变化

### 第三阶段：协议理解（3-4天）

1. 阅读 `doc/05_MCP协议详解.md`
2. 阅读 `doc/06_A2A协议详解.md`
3. 阅读 `doc/09_A2A分布式架构实现.md`
4. 调试各服务，理解通信流程

### 第四阶段：动手实践（持续）

1. 添加新的 MCP 工具
2. 添加新的 A2A Agent
3. 优化提示词效果

---

## 8. 常见问题

### Q1: 服务启动报错 "MySQL Connection not available"
**A:** MySQL 服务未启动。启动 MySQL 后重试。

### Q2: LLM 返回内容不准确
**A:** 检查提示词设计。LLM 的输出质量取决于提示词。

### Q3: Agent 显示离线
**A:** 对应的服务未启动。检查端口是否被占用。

### Q4: 为什么要用 3 层架构？
**A:** 
- **MCP 层**：纯工具，无业务逻辑，可复用
- **Agent 层**：业务逻辑，LLM 驱动
- **网关层**：统一入口，前端解耦

---

## 📁 项目文件结构

```
SmartVoyage/
├── api_gateway.py          # API 网关（意图识别+路由+润色）
├── streamlit_app_a2a.py    # Streamlit 前端（纯 UI）
├── smart_voyage_main.py    # 命令行客户端
├── main_prompts.py         # LLM 提示词管理
│
├── mcp_server/             # MCP 服务层
│   ├── mcp_weather_server.py   # 天气 MCP (:8002)
│   ├── mcp_ticket_server.py    # 票务 MCP (:8001)
│   └── mcp_order_server.py     # 订票 MCP (:8003)
│
├── a2a_server/             # A2A Agent 层
│   ├── weather_server.py   # 天气 Agent (:5005)
│   ├── ticket_server.py    # 票务 Agent (:5006)
│   └── order_server.py     # 订票 Agent (:5007)
│
├── config/                 # 配置模块
├── database/               # 数据库脚本
├── doc/                    # 学习文档
└── start_a2a.bat          # 一键启动脚本
```

---

## 🎯 学习建议

1. **先跑起来** - 不要急着看代码，先把项目跑起来体验
2. **看日志** - 每个服务都有 INFO 日志，能帮助理解数据流
3. **改提示词** - 修改 `main_prompts.py`，观察 LLM 行为变化
4. **加断点** - 用 PyCharm 调试，逐步跟踪请求流程
5. **看 API 文档** - http://localhost:8000/docs 有完整的 API 说明

---

**祝学习顺利！🚀**
