# 第六章：A2A 协议详解

## 学习目标

- 理解 A2A（Agent-to-Agent）协议
- 掌握 Agent Card 的设计
- 学会实现多代理协作

## 1. A2A 协议简介

### 什么是 A2A？

A2A（Agent-to-Agent Protocol）是代理间通信协议，用于：
- 不同 AI Agent 之间的协作
- Agent 能力发现和查询
- 任务分发和结果聚合

### A2A vs MCP

| 特性 | MCP | A2A |
|------|-----|-----|
| 通信对象 | LLM ↔ 工具 | Agent ↔ Agent |
| 主要用途 | 工具调用 | 多代理协作 |
| 发现机制 | 工具列表 | Agent Card |

## 2. Agent Card

Agent Card 是代理的"名片"，描述代理的能力：

```python
from python_a2a import AgentCard

card = AgentCard(
    name="SmartVoyage",
    description="智能旅行助手",
    version="1.0.0",
    capabilities=[
        "weather_query",
        "train_ticket_query"
    ],
    endpoint="http://localhost:8001",
    metadata={
        "author": "SmartVoyage Team",
        "languages": ["zh-CN"]
    }
)
```

## 3. 消息处理

### Message 结构

```python
from python_a2a import Message, MessageRole

message = Message(
    role=MessageRole.USER,
    content="北京明天天气怎么样？",
    metadata={"session_id": "abc123"}
)
```

### 消息处理器

```python
from python_a2a import A2AServer

server = A2AServer(
    agent_card=card,
    message_handler=handle_message
)

async def handle_message(message: Message) -> Message:
    # 处理用户消息
    response = process(message.content)
    
    return Message(
        role=MessageRole.ASSISTANT,
        content=response
    )
```

## 4. 任务状态

A2A 支持异步任务，通过状态跟踪进度：

```python
from python_a2a import TaskStatus

# 任务状态
TaskStatus.PENDING     # 待处理
TaskStatus.RUNNING     # 执行中
TaskStatus.COMPLETED   # 已完成
TaskStatus.FAILED      # 失败
TaskStatus.NEEDS_INPUT # 需要更多输入
```

## 5. 多代理协作示例

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  用户 Agent   │────▶│  路由 Agent   │────▶│  天气 Agent  │
│              │     │              │     │              │
└──────────────┘     └──────────────┘     └──────────────┘
                            │
                            ▼
                     ┌──────────────┐
                     │  票务 Agent  │
                     │              │
                     └──────────────┘
```

### 路由 Agent 实现

```python
class RouterAgent:
    def __init__(self):
        self.weather_agent = A2AClient("http://localhost:8001")
        self.ticket_agent = A2AClient("http://localhost:8002")
    
    async def route(self, intent: str, message: str):
        if intent == "weather":
            return await self.weather_agent.send(message)
        elif intent == "train_ticket":
            return await self.ticket_agent.send(message)
```

## 知识点总结

| 概念 | 说明 |
|------|------|
| A2A | Agent-to-Agent Protocol |
| Agent Card | 代理的能力描述卡片 |
| Message | 代理间传递的消息 |
| TaskStatus | 异步任务的状态 |

## 下一步

继续学习 [第七章：Streamlit 前端](07_Streamlit前端.md)
