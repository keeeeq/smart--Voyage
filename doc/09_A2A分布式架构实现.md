# ç¬¬ä¹ç« ï¼šA2A åˆ†å¸ƒå¼æ¶æ„å®ç°è¯¦è§£

## å­¦ä¹ ç›®æ ‡

- ç†è§£ SmartVoyage çš„ MCP + A2A åˆ†å¸ƒå¼æ¶æ„
- æŒæ¡å„æœåŠ¡ç»„ä»¶çš„å®ç°ç»†èŠ‚
- å­¦ä¼šå¯åŠ¨å’Œè°ƒè¯•åˆ†å¸ƒå¼ç³»ç»Ÿ

## 1. æ¶æ„æ¦‚è¿°

SmartVoyage é‡‡ç”¨ä¸‰å±‚åˆ†å¸ƒå¼æ¶æ„ï¼š

```
                           ç”¨æˆ·è¯·æ±‚
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Streamlit å‰ç«¯ (:8502)                    â”‚
â”‚                  æ„å›¾è¯†åˆ« â†’ Agent è·¯ç”±                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ A2A Protocol
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     A2A Agent å±‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ å¤©æ°”Agent     â”‚ â”‚ ç¥¨åŠ¡Agent     â”‚ â”‚ è®¢ç¥¨Agent     â”‚      â”‚
â”‚  â”‚ :5005         â”‚ â”‚ :5006         â”‚ â”‚ :5007         â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ MCP Protocol
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     MCP Server å±‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ å¤©æ°”MCP       â”‚ â”‚ ç¥¨åŠ¡MCP       â”‚ â”‚ è®¢ç¥¨MCP       â”‚      â”‚
â”‚  â”‚ :8002         â”‚ â”‚ :8001         â”‚ â”‚ :8003         â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
                         MySQL æ•°æ®åº“
```

## 2. MCP Server å±‚

### ä½œç”¨
- å°è£…æ•°æ®åº“æ“ä½œä¸º MCP å·¥å…·
- æä¾›æ ‡å‡†åŒ–çš„å·¥å…·è°ƒç”¨æ¥å£
- å¤„ç†æ•°æ®æ ¼å¼è½¬æ¢

### å®ç°æ–‡ä»¶

| æ–‡ä»¶ | ç«¯å£ | åŠŸèƒ½ |
|------|------|------|
| `mcp_server/mcp_weather_server.py` | 8002 | å¤©æ°”æ•°æ®æŸ¥è¯¢ |
| `mcp_server/mcp_ticket_server.py` | 8001 | ç¥¨åŠ¡æ•°æ®æŸ¥è¯¢ |
| `mcp_server/mcp_order_server.py` | 8003 | ç¥¨åŠ¡é¢„å®šæ“ä½œ |

### æ ¸å¿ƒä»£ç 

```python
from mcp.server.fastmcp import FastMCP

# åˆ›å»º FastMCP å®ä¾‹
ticket_mcp = FastMCP(
    name="TicketTools",
    host="127.0.0.1",
    port=8001
)

# æ³¨å†Œå·¥å…·
@ticket_mcp.tool(
    name="query_tickets",
    description="æŸ¥è¯¢ç¥¨åŠ¡æ•°æ®ï¼Œè¾“å…¥ SQL è¯­å¥"
)
def query_tickets(sql: str) -> str:
    return service.execute_query(sql)

# å¯åŠ¨æœåŠ¡ï¼ˆä½¿ç”¨ streamable-http ä¼ è¾“ï¼‰
ticket_mcp.run(transport="streamable-http")
```

### æ•°æ®åº“è¿æ¥è‡ªåŠ¨é‡è¿

```python
def _ensure_connection(self):
    """ç¡®ä¿æ•°æ®åº“è¿æ¥å¯ç”¨"""
    if self.conn is None or not self.conn.is_connected():
        self._connect()
```

## 3. A2A Agent å±‚

### ä½œç”¨
- æ¥æ”¶ç”¨æˆ·æŸ¥è¯¢ï¼Œç”Ÿæˆ SQL
- è°ƒç”¨ MCP Server æ‰§è¡ŒæŸ¥è¯¢
- æ ¼å¼åŒ–è¿”å›ç»“æœ

### å®ç°æ–‡ä»¶

| æ–‡ä»¶ | ç«¯å£ | ä¾èµ– |
|------|------|------|
| `a2a_server/weather_server.py` | 5005 | MCPå¤©æ°” (:8002) |
| `a2a_server/ticket_server.py` | 5006 | MCPç¥¨åŠ¡ (:8001) |
| `a2a_server/order_server.py` | 5007 | ç¥¨åŠ¡Agent + MCPè®¢ç¥¨ |

### æ ¸å¿ƒä»£ç 

```python
from python_a2a import A2AServer, AgentCard, run_server

# å®šä¹‰ Agent Card
agent_card = AgentCard(
    name="TicketQueryAssistant",
    description="ç¥¨åŠ¡æŸ¥è¯¢åŠ©æ‰‹",
    url="http://localhost:5006",
    skills=[
        AgentSkill(
            name="execute ticket query",
            description="æ‰§è¡Œç¥¨åŠ¡æŸ¥è¯¢"
        )
    ]
)

# å®ç° A2A Server
class TicketQueryServer(A2AServer):
    def handle_task(self, task):
        # 1. ä» task è·å–ç”¨æˆ·è¾“å…¥
        conversation = task.message["content"]["text"]
        
        # 2. LLM ç”Ÿæˆ SQL
        sql = self.generate_sql(conversation)
        
        # 3. è°ƒç”¨ MCP æ‰§è¡ŒæŸ¥è¯¢
        result = asyncio.run(get_tickets(sql))
        
        # 4. è¿”å›ç»“æœ
        task.artifacts = [{"parts": [{"text": result}]}]
        task.status = TaskStatus(state=TaskState.COMPLETED)
        return task

# å¯åŠ¨æœåŠ¡
run_server(server, host="127.0.0.1", port=5006)
```

### SQL ç”Ÿæˆæç¤ºè¯

```python
SQL_PROMPT = ChatPromptTemplate.from_template("""
## æ•°æ®åº“è¡¨ç»“æ„

### concert_ticketï¼ˆæ¼”å”±ä¼šè¡¨ï¼‰
- artist: è‰ºäººåç§°
- city: åŸå¸‚
- venue: åœºé¦†
- show_date: æ¼”å‡ºæ—¥æœŸï¼ˆæ³¨æ„ï¼šä¸æ˜¯ event_dateï¼‰

## è§„åˆ™
1. è¾“å‡ºç±»å‹ JSONï¼š{"type": "concert"}
2. è¾“å‡º SQLï¼šSELECT * FROM concert_ticket WHERE ...
""")
```

## 4. å®¢æˆ·ç«¯å±‚

### Streamlit å‰ç«¯ (`streamlit_app_a2a.py`)

```python
# æ„å›¾è¯†åˆ«
intents, queries, _ = intent_recognize(user_input)

# æ ¹æ®æ„å›¾é€‰æ‹© Agent
for intent in intents:
    if intent == "weather":
        agent_name = "WeatherQueryAssistant"
    elif intent in ["train", "flight", "concert"]:
        agent_name = "TicketQueryAssistant"
    elif intent == "order":
        agent_name = "TicketOrderAssistant"
    
    # è°ƒç”¨ Agent
    result = await call_agent(agent_name, query)
```

### å‘½ä»¤è¡Œå®¢æˆ·ç«¯ (`smart_voyage_main.py`)

æä¾›å‘½ä»¤è¡Œäº¤äº’ç•Œé¢ï¼Œé€»è¾‘ä¸ Streamlit ç±»ä¼¼ã€‚

## 5. é€šä¿¡åè®®

### MCP è°ƒç”¨

```python
from mcp import ClientSession
from mcp.client.streamable_http import streamablehttp_client

async with streamablehttp_client("http://127.0.0.1:8001/mcp") as (read, write, _):
    async with ClientSession(read, write) as session:
        await session.initialize()
        result = await session.call_tool("query_tickets", {"sql": sql})
```

### A2A è°ƒç”¨

```python
from python_a2a import A2AClient, Message, Task

client = A2AClient("http://localhost:5006")
message = Message(content=TextContent(text=query), role=MessageRole.USER)
task = Task(id="task-xxx", message=message.to_dict())
result = await client.send_task_async(task)
```

## 6. ç«¯å£åˆ†é…

| æœåŠ¡ | ç«¯å£ | åè®® |
|------|------|------|
| MCP ç¥¨åŠ¡ | 8001 | MCP/HTTP |
| MCP å¤©æ°” | 8002 | MCP/HTTP |
| MCP è®¢ç¥¨ | 8003 | MCP/HTTP |
| A2A å¤©æ°” | 5005 | A2A/HTTP |
| A2A ç¥¨åŠ¡ | 5006 | A2A/HTTP |
| A2A è®¢ç¥¨ | 5007 | A2A/HTTP |
| Streamlit | 8502 | HTTP |

## 7. å¯åŠ¨æ–¹å¼

### æ–¹å¼1ï¼šä¸€é”®å¯åŠ¨è„šæœ¬
```bash
start_a2a.bat
```

### æ–¹å¼2ï¼šPyCharm è¿è¡Œé…ç½®
é€‰æ‹© "ğŸš€ å¯åŠ¨å…¨éƒ¨æœåŠ¡" è¿è¡Œé…ç½®

### æ–¹å¼3ï¼šæ‰‹åŠ¨å¯åŠ¨
```bash
# MCP å±‚ï¼ˆ3ä¸ªç»ˆç«¯ï¼‰
python mcp_server/mcp_weather_server.py
python mcp_server/mcp_ticket_server.py
python mcp_server/mcp_order_server.py

# A2A å±‚ï¼ˆ3ä¸ªç»ˆç«¯ï¼‰
python a2a_server/weather_server.py
python a2a_server/ticket_server.py
python a2a_server/order_server.py

# å‰ç«¯
streamlit run streamlit_app_a2a.py
```

## 8. è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹æ—¥å¿—
æ¯ä¸ªæœåŠ¡éƒ½æœ‰ INFO çº§åˆ«æ—¥å¿—ï¼Œæ˜¾ç¤ºï¼š
- æ”¶åˆ°çš„æŸ¥è¯¢
- ç”Ÿæˆçš„ SQL
- MCP è¿”å›ç»“æœ

### å¸¸è§é—®é¢˜

| é—®é¢˜ | åŸå›  | è§£å†³ |
|------|------|------|
| Unknown column | SQL åˆ—åé”™è¯¯ | æ£€æŸ¥æç¤ºè¯ä¸­çš„è¡¨ç»“æ„å®šä¹‰ |
| MySQL Connection | æ•°æ®åº“æ–­è¿ | æœåŠ¡å·²æœ‰è‡ªåŠ¨é‡è¿æœºåˆ¶ |
| Agent ç¦»çº¿ | æœåŠ¡æœªå¯åŠ¨ | æ£€æŸ¥å¯¹åº”ç«¯å£çš„æœåŠ¡ |

## çŸ¥è¯†ç‚¹æ€»ç»“

| æ¦‚å¿µ | è¯´æ˜ |
|------|------|
| FastMCP | å¿«é€Ÿåˆ›å»º MCP Server çš„åº“ |
| streamable-http | MCP çš„ HTTP ä¼ è¾“æ–¹å¼ |
| A2AServer | python-a2a çš„æœåŠ¡ç«¯åŸºç±» |
| AgentCard | Agent çš„èƒ½åŠ›æè¿°å¡ç‰‡ |
| handle_task | A2A ä»»åŠ¡å¤„ç†å…¥å£æ–¹æ³• |

## ä¸‹ä¸€æ­¥

å°è¯•ä¿®æ”¹ Agent çš„æç¤ºè¯ï¼Œæ·»åŠ æ–°çš„æŸ¥è¯¢åŠŸèƒ½ï¼
