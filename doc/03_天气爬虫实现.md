# 第三章：天气爬虫实现

## 学习目标

- 了解 Web API 的基本概念
- 掌握使用 requests 库发送 HTTP 请求
- 学会解析 JSON 数据并存入数据库

## 1. 和风天气 API

### API 简介

和风天气提供免费的天气数据 API：
- 注册地址：https://dev.qweather.com/
- 免费版限制：每天 1000 次调用

### API 调用示例

```
GET https://devapi.qweather.com/v7/weather/7d?location=101010100&key=YOUR_KEY
```

返回数据（JSON 格式）：
```json
{
  "code": "200",
  "daily": [
    {
      "fxDate": "2025-01-12",
      "tempMax": "28",
      "tempMin": "18",
      "textDay": "晴"
    }
  ]
}
```

## 2. HTTP 请求

### requests 库

Python 最流行的 HTTP 库：

```python
import requests

# GET 请求
response = requests.get(
    "https://api.example.com/weather",
    params={"city": "北京"},  # URL 参数
    timeout=10  # 超时时间
)

# 检查状态
if response.status_code == 200:
    data = response.json()  # 解析 JSON
```

### 错误处理

```python
from requests.exceptions import RequestException

try:
    response = requests.get(url, timeout=10)
    response.raise_for_status()  # 非 2xx 状态码会抛出异常
except RequestException as e:
    print(f"请求失败: {e}")
```

## 3. 爬虫实现

```python
# crawler/weather_crawler.py

class WeatherCrawler:
    def __init__(self):
        self.api_key = settings.qweather_api_key
        self.base_url = settings.qweather_base_url
    
    def fetch_weather(self, city_code: str) -> list:
        """获取 7 日天气预报"""
        url = f"{self.base_url}/weather/7d"
        params = {
            "location": city_code,
            "key": self.api_key
        }
        
        response = requests.get(url, params=params, timeout=10)
        data = response.json()
        
        if data.get("code") == "200":
            return self._parse_weather(data["daily"])
        return []
    
    def _parse_weather(self, daily_data: list) -> list:
        """解析天气数据"""
        result = []
        for day in daily_data:
            result.append({
                "fx_date": day["fxDate"],
                "temp_max": int(day["tempMax"]),
                "temp_min": int(day["tempMin"]),
                "text_day": day["textDay"]
            })
        return result
```

## 4. 数据存储

### UPSERT 操作

"有则更新，无则插入" 的逻辑：

```sql
INSERT INTO weather_data (city, fx_date, temp_max)
VALUES ('北京', '2025-01-12', 28)
ON DUPLICATE KEY UPDATE
    temp_max = VALUES(temp_max);
```

### 实现代码

```python
def save_weather(self, city: str, weather_list: list):
    sql = """
    INSERT INTO weather_data (city, fx_date, temp_max, temp_min, text_day)
    VALUES (%s, %s, %s, %s, %s)
    ON DUPLICATE KEY UPDATE
        temp_max = VALUES(temp_max),
        temp_min = VALUES(temp_min),
        text_day = VALUES(text_day)
    """
    
    for w in weather_list:
        DatabaseConnection.execute_update(
            sql, (city, w["fx_date"], w["temp_max"], w["temp_min"], w["text_day"])
        )
```

## 5. 定时任务

使用 `schedule` 库实现定时更新：

```python
import schedule
import time

def update_weather_job():
    crawler = WeatherCrawler()
    crawler.update_hot_cities()
    print("天气数据已更新")

# 每天早上 6 点执行
schedule.every().day.at("06:00").do(update_weather_job)

# 运行调度器
while True:
    schedule.run_pending()
    time.sleep(60)
```

## 知识点总结

| 概念 | 说明 |
|------|------|
| REST API | 基于 HTTP 的 Web 服务接口 |
| requests | Python HTTP 请求库 |
| JSON | 数据交换格式 |
| UPSERT | INSERT + UPDATE 的合并操作 |
| schedule | 轻量级定时任务库 |

## 下一步

继续学习 [第四章：LLM 与 SQL 生成](04_LLM与SQL生成.md)
