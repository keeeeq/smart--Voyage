# 第二章：数据库设计与连接

## 学习目标

- 理解关系型数据库的基本概念
- 掌握 MySQL 数据库设计原则
- 学会使用 Python 连接和操作 MySQL

## 1. 数据库设计

### 表结构设计原则

1. **主键（Primary Key）**：每张表都应有唯一标识符
2. **索引（Index）**：在常用查询字段上创建索引
3. **外键（Foreign Key）**：建立表之间的关联关系
4. **范式化**：减少数据冗余，保持数据一致性

### SmartVoyage 数据表

```sql
-- 天气数据表
CREATE TABLE weather_data (
    id INT AUTO_INCREMENT PRIMARY KEY,  -- 主键
    city VARCHAR(50) NOT NULL,          -- 城市
    fx_date DATE NOT NULL,              -- 日期
    temp_max INT,                       -- 最高温
    temp_min INT,                       -- 最低温
    text_day VARCHAR(50),               -- 天气描述
    
    INDEX idx_city_date (city, fx_date) -- 复合索引
);
```

### 为什么使用复合索引？

当查询条件同时包含城市和日期时：
```sql
SELECT * FROM weather_data WHERE city = '北京' AND fx_date = '2025-01-12'
```
复合索引 `(city, fx_date)` 可以大幅提升查询速度。

## 2. 数据库连接

### 连接池（Connection Pool）

**问题**：每次查询都创建新连接，开销太大
**解决**：使用连接池，复用已建立的连接

```python
from mysql.connector import pooling

pool = pooling.MySQLConnectionPool(
    pool_name="my_pool",
    pool_size=5,  # 保持 5 个连接
    host="localhost",
    user="root",
    password="root",
    database="smart_voyage"
)

# 获取连接（从池中取出）
conn = pool.get_connection()

# 使用完毕后关闭（归还到池中）
conn.close()
```

### 上下文管理器

使用 `with` 语句确保连接正确释放：

```python
from contextlib import contextmanager

@contextmanager
def get_connection():
    conn = pool.get_connection()
    try:
        yield conn  # 返回连接给调用者
    finally:
        conn.close()  # 无论如何都会执行

# 使用
with get_connection() as conn:
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM weather_data")
```

## 3. SQL 查询

### 参数化查询（防止 SQL 注入）

**错误示例**（有安全风险）：
```python
city = "北京"
sql = f"SELECT * FROM weather_data WHERE city = '{city}'"
```

**正确示例**（使用参数占位符）：
```python
sql = "SELECT * FROM weather_data WHERE city = %s"
cursor.execute(sql, (city,))  # 参数作为元组传入
```

### 批量插入

```python
sql = "INSERT INTO weather_data (city, temp_max) VALUES (%s, %s)"
data = [("北京", 28), ("上海", 32), ("广州", 35)]

cursor.executemany(sql, data)  # 批量执行，效率更高
conn.commit()
```

## 4. 实践代码

```python
# database/connection.py

from config import settings
from mysql.connector import pooling

class DatabaseConnection:
    _pool = None
    
    @classmethod
    def init_pool(cls):
        cls._pool = pooling.MySQLConnectionPool(
            pool_size=5,
            host=settings.mysql_host,
            port=settings.mysql_port,
            user=settings.mysql_user,
            password=settings.mysql_password,
            database=settings.mysql_database
        )
    
    @classmethod
    def execute_query(cls, sql, params=None):
        conn = cls._pool.get_connection()
        cursor = conn.cursor(dictionary=True)  # 返回字典格式
        try:
            cursor.execute(sql, params or ())
            return cursor.fetchall()
        finally:
            cursor.close()
            conn.close()
```

## 知识点总结

| 概念 | 说明 |
|------|------|
| 主键 | 唯一标识表中的每条记录 |
| 索引 | 加速查询的数据结构 |
| 连接池 | 复用数据库连接，提高性能 |
| 上下文管理器 | 使用 with 语句自动管理资源 |
| 参数化查询 | 防止 SQL 注入的安全写法 |

## 下一步

继续学习 [第三章：天气爬虫实现](03_天气爬虫实现.md)
